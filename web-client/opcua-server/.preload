trace("Starting OPCUA server")

local ua = require("opcua.api")
local gettime=os.time

-- Connect logging traces
ua.trace.dbg = function(msg)
  trace(gettime(), "[DBG] ", msg)
end

-- Connect logging if not bundled with Lua tutorials
ua.trace.inf = not _G.demo and function(msg)
  trace(gettime(), "[INF]", msg)
end

ua.trace.err = function(msg)
  trace(gettime(), "[ERR]", msg)
end

local conf = io:dofile(".opcua_config", _ENV)
local ok
ok,uaServer = pcall(ua.newServer,conf)
if not ok then
   trace"Error: server too old for OPCUA example"
   dir:unlink()
   return
end

local function demoAddon(services)
  local objects = "i=40"
  io:dofile(".lua/add_variables.lua")(services, objects)
end

uaServer:initialize(demoAddon)
uaServer:run()

function onunload()
  trace("Stopping OPC-UA server")
  uaServer:shutdown()
end


_G.uaServices = uaServer.services
