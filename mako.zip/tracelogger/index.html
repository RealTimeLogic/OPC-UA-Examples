<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<style>

body {
margin:0;
padding:0;
position: relative;
}

#ctrl {
padding:5px;
background:#333333;
color:white;
position:fixed;
top:0;
border-bottom: 1px solid #666;
min-width:615px;
overflow: hidden;
}

#ctrl, #tracecont {
width:100%;
left:0;
}

#ctrl button { width: 150px;}

#tracecont { margin-top:80px; }

#console {
margin: 0 5px 0 5px;
font: 10pt "courier new",monospace;
}

span.err {
    font-weight:bold;
    color:red;
}

.led-red, .led-green {
    width: 25px;
    height: 25px;
    border-radius: 50%;
}


.led-red {
    background-color: #B40404;
    box-shadow: #000 0 -1px 7px 1px, inset #600 0 -1px 9px, #F00 0 2px 12px;
}

.led-green {
    background-color: #04B404;
    box-shadow: #000 0 -1px 7px 1px, inset #460 0 -1px 9px, #7D0 0 2px 12px;
}

</style>
<title>TraceLogger</title>
<script type="text/javascript" src="/rtl/jquery.js"></script>
<script>


// The URL to the trace logger's EventHandler service.
var trUrl = "/rtl/tracelogger.service/"

var docUrl="https://realtimelogic.com/ba/doc/?url=auxlua.html#tracelogger";

//Must match C code
var TR_set =      1
var TR_data =     2
var TR_acquired = 3

var TS_Http11State =       1
var TS_Request =           2
var TS_RequestHeaders =    3
var TS_setResponseHeaders= 4
var TS_setResponseBody =   5
var TS_TraceButtonState =  6
var TS_TraceLevel =        7

// Convert from array position 1
function Utf8ArrayToStr(array) {
    var out, i, len, c;
    var char2, char3;

    out = "";
    len = array.length;
    i = 1;
    while(i < len) {
        c = array[i++];
        switch(c >> 4)
        { 
        case 0: case 1: case 2: case 3: case 4: case 5: case 6: case 7:
            // 0xxxxxxx
            if(c >= 32 || c >= 10)
                out += String.fromCharCode(c);
            break;
        case 12: case 13:
            // 110x xxxx   10xx xxxx
            char2 = array[i++];
            out += String.fromCharCode(((c & 0x1F) << 6) | (char2 & 0x3F));
            break;
        case 14:
            // 1110 xxxx  10xx xxxx  10xx xxxx
            char2 = array[i++];
            char3 = array[i++];
            out += String.fromCharCode(((c & 0x0F) << 12) |
                                       ((char2 & 0x3F) << 6) |
                                       ((char3 & 0x3F) << 0));
            break;
        }
    }
    return out;
};

function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
};


$(function() {

    var serverSetTraceState;
    var conElem=$("#console");
    var conHasData=false;
    var websock=null;

    function clearCon() {
        conHasData=false;
        conElem.empty();
        $("#EraseTrace").prop("disabled",true);
    };

    function writeCon(txt) {
        if(!conHasData) {
            conHasData=true;
            $("#EraseTrace").prop("disabled",false);
        }
        conElem.append(txt);
        if (document.body.scrollHeight)
            window.scrollTo(0, document.body.scrollHeight);  
    };

    function writeConErr(txt) {
        writeCon("\n<span class='err'>"+txt+"</span>");
    }

    function isChecked(self) {
        return $(self).prop('checked');
    };

    function setChecked(elem, checked) {
        return $("#"+elem).prop('checked',checked);
    };

    function setConnectedState(connected) {
        $("#led").removeClass().addClass(connected ? "led-green" : "led-red");
        setConnectBut("Connect", false);
        eh=null;
    };

    function setConnectBut(txt, disabled) {
        $("#ToggleConnect").html(txt).prop("disabled",disabled);
    };

    function setDisconState() {
        websock=null;
        setConnectedState(false);
        setConnectBut("Connect", false);
    };

    function startWS() {
        var proto = location.protocol === 'https:' ? 'wss://' : 'ws://';
        var ws = new WebSocket(proto+location.host+trUrl);
        ws.binaryType = "arraybuffer";
        ws.onopen = function(ev)
        {
            setConnectedState(true);
            setConnectBut("Disconnect", false);
            websock=ws;
            writeCon("Connected!\n");
        };
        ws.onmessage = function (ev)
        {
            var d = new Uint8Array(ev.data);
            switch(d[0]) {
            case TR_set:
                setChecked("SetRequest",        d[1]?true:false);
                setChecked("SetRequestHeaders", d[2]?true:false);
                setChecked("SetResponseHeaders",d[3]?true:false);
                setChecked("SetHttp11State",    d[4]?true:false);
                setChecked("SetResponseBody",   d[5]?true:false);
                $("#TraceLevel").val(d[6]);
                break;
            case TR_data:
                writeCon(escapeHtml(Utf8ArrayToStr(d)));
                break;
            case TR_acquired:
                writeConErr("Connection closed by another client.\n");
                break
            }
        };
        ws.onclose = function(ev)
        { 
            if(websock) {
                setDisconState();
                writeConErr("WebSocket connection closed with code: "+ev.code+".\n");
            }
            else
                writeCon("Disconnected!\n");
        };
    };
    
    function connect(force) {
        setConnectBut("Connecting...", true);
        function ajaxRsp(jqXHR) {
            if( jqXHR.getResponseHeader('tracelogger') && 
                (jqXHR.status == 204 || jqXHR.status == 503) )
            {
                if(jqXHR.status == 204 || force) {
                    startWS();
                }
                else {
                    setConnectBut("Connect", false);
                    writeConErr("The TraceLogger is serving another client.\n"+
                                "Click the Connect button to force the other client to disconnect!\n");
                }
            }
            else
            {
                setConnectBut("Cannot Connect",true);
                writeConErr("Service at "+trUrl+" is not a TraceLogger or the TraceLogger service is not running!\n"+
                            "See the <a href='"+docUrl+"'>documentation</a> for details.\n");
            }
        };
        $.ajax({
            url:trUrl,
            success: function(data, textStatus, jqXHR){ ajaxRsp(jqXHR); },
            error: function (jqXHR){ ajaxRsp(jqXHR); }
        });
    };
    clearCon();
    writeCon("Starting <a target='_blank' href='"+docUrl+"'>TraceLogger</a>....\n");
    connect(false);

    function sendCmd(cmd, val) {
        if(websock) {
            var d = new Uint8Array(2);
            d[0]=cmd;
            d[1]=val;
            websock.send(d);
        };
    };

    $("#SetRequest").click(function(){sendCmd(TS_Request,isChecked(this));});
    $("#SetRequestHeaders").click(function(){
        sendCmd(TS_RequestHeaders,isChecked(this));
        if(isChecked(this)) setChecked("SetRequest", true);
    });
    $("#SetResponseHeaders").click(function(){sendCmd(TS_setResponseHeaders,isChecked(this));});
    $("#SetResponseBody").click(function(){
        if(isChecked("#SetResponseHeaders")) {
            sendCmd(TS_setResponseHeaders,false);
            setChecked("SetResponseHeaders", false);
        }
        sendCmd(TS_setResponseBody,isChecked(this));
    });
    $("#SetHttp11State").click(function(){sendCmd(TS_Http11State,isChecked(this));});
    $("#TraceLevel").click(function() {sendCmd(TS_TraceLevel,$(this).val());});
    $("#EraseTrace").click(clearCon);
    $("#ToggleConnect").click(function() {
        if(websock) { websock.close(); websock=null; setDisconState(); }
        else connect(true);
    });
});



</script>
</head>
<body>
<div id="ctrl">
<table>
  <tr>
    <td><input id="SetRequest" type="checkbox"/> Request</td>
    <td><input id="SetResponseHeaders" type="checkbox" /> Response Headers</td>
    <td><input id="SetHttp11State" type="checkbox"/> HTTP 1.1 State</td>
    <td><button id="EraseTrace">Erase Trace</button></td>
    <td></td>
    <td></td>
  </tr>
  <tr>
    <td><input id="SetRequestHeaders" type="checkbox" /> Request Headers</td>
    <td><input id="SetResponseBody" type="checkbox" /> Response Body</td>
    <td>
      Trace Level&nbsp;&nbsp;
      <select id="TraceLevel" name="TraceLevel">
        <option value="0">&nbsp;0</option>
        <option value="1">&nbsp;1</option>
        <option value="2">&nbsp;2</option>
        <option value="3">&nbsp;3</option>
        <option value="4">&nbsp;4</option>
        <option value="5">&nbsp;5</option>
        <option value="6">&nbsp;6</option>
        <option value="7">&nbsp;7</option>
        <option value="8">&nbsp;8</option>
        <option value="9">&nbsp;9</option>
        <option value="9">&nbsp;10</option>
        <option value="9">&nbsp;15</option>
        <option value="9">&nbsp;20</option>
      </select>
    </td>
    <td><button id="ToggleConnect">Connect</button></td>
    <td></td>
    <td><div id="led" class="led-red"></div></td>
  </tr>
</table>
</div>
<div id="tracecont"><pre id="console"><span class='err'>JavaScript not enabled!</span></pre></div>
</body>
</html>
